# SQL Telegram Bot

–ü—Ä–æ—Å—Ç–æ–π Telegram-–±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –≤ SQL-–∑–∞–ø—Ä–æ—Å—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL.

---

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç

- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ –≤–∏–¥–µ–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ—Å–º–æ—Ç—Ä—ã, –ª–∞–π–∫–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏).
- –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏—Ö –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON-–∑–∞–ø—Ä–æ—Å.
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL –∏ –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ PostgreSQL.
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–¥—Å—á—ë—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ, —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–∏—Ä–æ—Å—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π (delta).
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LLM (ChatGPT) –¥–ª—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≤–∞–ª–∏–¥–Ω–æ–≥–æ JSON –ø–æ —Å—Ç—Ä–æ–≥–æ–π —Å—Ö–µ–º–µ.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

1. **Telegram Bot** (aiogram) ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç—ã.  
2. **SQL Parser** ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç JSON –æ—Ç LLM –≤ SQLAlchemy-–∑–∞–ø—Ä–æ—Å.  
3. **PostgreSQL** ‚Äî —Ö—Ä–∞–Ω–∏—Ç —Ç–∞–±–ª–∏—Ü—ã `videos` –∏ `video_snapshots`.  
4. **LLM (ChatGPT)** ‚Äî –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–º–ø—Ç–∞ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫ –≤ —Å—Ç—Ä–æ–≥–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON.  
5. **JSON ‚Üí SQL** ‚Äî —Å –ø–æ–º–æ—â—å—é Python –∏ SQLAlchemy —Å—Ç—Ä–æ–∏—Ç—Å—è SQL-–∑–∞–ø—Ä–æ—Å –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –ë–î.

**–ü–æ–¥—Ö–æ–¥ –∫ JSON –∏ SQL**:  

- –î–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ –≤—Å–µ–≥–¥–∞ `aggregation=count`, `entity=videos`, `field=id`.
- –î–ª—è –ø—Ä–∏—Ä–æ—Å—Ç–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π ‚Äî `aggregation=delta`, `entity=video_snapshots`, `field=delta_*`.
- –§–∏–ª—å—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ –¥–æ–ø—É—Å—Ç–∏–º—ã–º —Å—É—â–Ω–æ—Å—Ç—è–º.
- –õ—é–±–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Üí JSON —Å `{"error": "Invalid field for entity"}`.

**LLM –∏ –ø—Ä–æ–º–ø—Ç**:

- –°—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö –æ–ø–∏—Å–∞–Ω–∞ –ø—Ä—è–º–æ –≤ –ø—Ä–æ–º–ø—Ç–µ: —Ç–∞–±–ª–∏—Ü—ã, –ø–æ–ª—è, –ø—Ä–∞–≤–∏–ª–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª–µ–π –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤.  
- –ü—Ä–æ–º–ø—Ç —Å—Ç—Ä–æ–≥–æ –¥–∏–∫—Ç—É–µ—Ç: –∫–∞–∫–∏–µ –ø–æ–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è count, sum, delta, –∫–∞–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã, –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–∏–¥–µ–æ.  
- LLM –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Ç–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ SQL.

–ü—Ä–æ–º–ø—Ç:
```
–¢—ã ‚Äî –ø–∞—Ä—Å–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –≤ JSON —Å—Ç—Ä–æ–≥–æ –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–π —Å—Ö–µ–º–µ.

‚ùóÔ∏è–ü—Ä–∞–≤–∏–ª–∞:
- –í–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û JSON, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞, –±–µ–∑ markdown
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—è –∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –¢–û–õ–¨–ö–û –≤ —Ç–µ—Ö –º–µ—Å—Ç–∞—Ö, –≥–¥–µ –æ–Ω–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è. "start_date", "end_date", "creator_id", "min_views", "negative_only", "all_time" –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –≤ filters.
- –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ –≤—ã—Ä–∞–∑–∏—Ç—å ‚Äî –≤–µ—Ä–Ω–∏ {"error": "cannot_parse"}
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –ø–æ–ª—è –∏–ª–∏ —Ç–∞–±–ª–∏—Ü—ã
- –î–∞—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO: YYYY-MM-DD –∏–ª–∏ YYYY-MM-DD HH:MM:SS
- –í—Å–µ —É—Å–ª–æ–≤–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã—Ä–∞–∂–µ–Ω—ã —á–µ—Ä–µ–∑ filters
- –°–ª–æ–≤–æ "–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ" –∏–≥–Ω–æ—Ä–∏—Ä—É–π. –¢–æ–ª—å–∫–æ –¥–∞—Ç—ã –∏–º–µ—é—Ç –∑–Ω–∞—á–µ–Ω–∏–µ.

üì¶ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:

1) videos ‚Äî –∏—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∏–¥–µ–æ
–ü–æ–ª—è:
- id
- creator_id
- video_created_at
- views_count
- likes_count
- comments_count
- reports_count

2) video_snapshots ‚Äî –ø–æ—á–∞—Å–æ–≤—ã–µ –∑–∞–º–µ—Ä—ã
–ü–æ–ª—è:
- id
- video_id
- views_count
- delta_views_count
- created_at

üì¶ –°—Ö–µ–º–∞ JSON (—Å—Ç—Ä–æ–≥–æ):

{
  "aggregation": "count" | "sum",
  "entity": "videos" | "video_snapshots",
  "field": "id" | "views_count" | "delta_views_count",
  "is_distinct": true | false,
  "filters": {
    "start_date": "YYYY-MM-DD" | "YYYY-MM-DD HH:MM:SS",
    "end_date": "YYYY-MM-DD" | "YYYY-MM-DD HH:MM:SS",
    "creator_id": "string",
    "min_views": number,
    "negative_only": true,
    "all_time": true
  }
}

üìå –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è:
- "–∏—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" ‚Üí videos.views_count
- "–∑–∞–º–µ—Ä—ã", "–ø–æ—á–∞—Å–æ–≤—ã–µ", "–∏–∑–º–µ–Ω–µ–Ω–∏–µ" ‚Üí video_snapshots.delta_views_count
- "–≤ –ø–µ—Ä–∏–æ–¥" ‚Üí start_date + end_date
- "–ø–æ –¥–∞—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏" ‚Üí videos.video_created_at
- "–ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–º–µ—Ä–∞" ‚Üí video_snapshots.created_at
- "—Å–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ" ‚Üí count(id)
- "—Å—É–º–º–∞—Ä–Ω–æ" ‚Üí sum(...)
- "—Ä–∞–∑–Ω—ã—Ö" ‚Üí is_distinct = true
- –ï—Å–ª–∏ –≤ –≤–æ–ø—Ä–æ—Å–µ –ù–ï–¢ —Å–ª–æ–≤–∞ "—Ä–∞–∑–Ω—ã—Ö" –∏–ª–∏ "—É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö" ‚Äî –í–°–ï–ì–î–ê —Å—Ç–∞–≤—å "is_distinct": false.
- "–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ" ‚Üí negative_only = true
- "–∫—Ä–µ–∞—Ç–æ—Ä" ‚Üí creator_id
- –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ª–æ–≤–æ "—Ä–∞–∑–Ω—ã—Ö", field –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–µ–º –æ–±—ä–µ–∫—Ç–æ–º, –∫–æ—Ç–æ—Ä—ã–π —Å—á–∏—Ç–∞—é—Ç.
```

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ

1. –°–∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:

```bash
git clone <repo_url>
cd <repo_name>
```

2. –°–æ–∑–¥–∞—Ç—å .env —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:
```
TELEGRAM_TOKEN=<–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞>
DATABASE_URL=postgresql://user:password@db:5432/dbname
```
–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å, —Å–æ–∑–¥–∞–≤ –±–æ—Ç–∞ –≤ –±–æ—Ç–µ BotFather –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ.

3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:
```
docker-compose up --build
```

4. –ë–æ—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ Telegram.


## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ –≤–æ–ø—Ä–æ—Å –±–æ—Ç—É –≤ Telegram –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä:  
  *¬´–°–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ –Ω–∞–±—Ä–∞–ª–æ –±–æ–ª—å—à–µ 100 000 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤?¬ª*  
- –ë–æ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å–ª–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã.
